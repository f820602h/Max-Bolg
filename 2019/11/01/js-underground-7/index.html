<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>JS地下城 - Canvas | Max&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="本篇為六角學院 - JS地下城攻略文　Github｜Demo    確認需求 讓使用者可以使用滑鼠在畫布上繪圖 畫筆要可以進行基本設定(粗細、顏色) 一些畫布的基本功能(清空、復原、重做) 能夠將畫作下載為圖檔  另外還可以設計一些額外功能作為加分項目  解題攻略  # 準備畫布先查查 MDN，發現原來要先建構 &lt;canvas&gt; 的渲染環境，用 getContext(&#39;2d&amp;">
<meta property="og:type" content="article">
<meta property="og:title" content="JS地下城 - Canvas">
<meta property="og:url" content="https://maxleebk.com/2019/11/01/js-underground-7/index.html">
<meta property="og:site_name" content="Max&#39;s Blog">
<meta property="og:description" content="本篇為六角學院 - JS地下城攻略文　Github｜Demo    確認需求 讓使用者可以使用滑鼠在畫布上繪圖 畫筆要可以進行基本設定(粗細、顏色) 一些畫布的基本功能(清空、復原、重做) 能夠將畫作下載為圖檔  另外還可以設計一些額外功能作為加分項目  解題攻略  # 準備畫布先查查 MDN，發現原來要先建構 &lt;canvas&gt; 的渲染環境，用 getContext(&#39;2d&amp;">
<meta property="og:locale" content="zh">
<meta property="og:image" content="https://cdn-images-1.medium.com/max/6240/1*Os7N1DpSdK-2o7IxTLERww.png">
<meta property="og:image" content="https://cdn-images-1.medium.com/max/6288/1*Mtx3i8B45xDlW3cqikDc2A.png">
<meta property="og:image" content="https://cdn-images-1.medium.com/max/5876/1*nh08sP6qPOrNvnRh-23sNg.png">
<meta property="og:image" content="https://maxleebk.com/2019/11/01/js-underground-7/color1.png">
<meta property="og:image" content="https://maxleebk.com/2019/11/01/js-underground-7/color2.png">
<meta property="article:published_time" content="2019-11-01T12:46:25.000Z">
<meta property="article:modified_time" content="2021-09-20T21:55:45.161Z">
<meta property="article:author" content="Max Lee">
<meta property="article:tag" content="JavaScript">
<meta property="article:tag" content="Canvas">
<meta property="article:tag" content="JS地下城">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn-images-1.medium.com/max/6240/1*Os7N1DpSdK-2o7IxTLERww.png">
  
    <link rel="alternate" href="/atom.xml" title="Max&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/css/images/favicon.ico">
  
  <link href="https://fonts.googleapis.com/css2?family=Fira+Code&display=swap" rel="stylesheet">
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.2.1"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-landing">
      <a href="/" id="header-avatar"></a>
      <div id="header-title">
        <h1 id="logo-wrap">
          <a href="/" id="logo">Max&#39;s Blog</a>
        </h1>
        
          <h2 id="subtitle-wrap">
            <a href="/" id="subtitle">Max Your Mind</a>
          </h2>
        
      </div>
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Article</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
      </nav>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-js-underground-7" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        <div class="article-header-wrap">
          
  
    <h1 class="article-title" itemprop="name">
      JS地下城 - Canvas
    </h1>
  

          <div>
            <p class="article-date">
  Posted by Max on
  <time datetime="2019-11-01T12:46:25.000Z" itemprop="datePublished">2019-11-01</time>
</p>
          </div>
        </div>
      </header>
    
    
        <div class="article-excerpt" itemprop="articleBody">
          <div class="post-cate">
            
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Canvas/" rel="tag">Canvas</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JS%E5%9C%B0%E4%B8%8B%E5%9F%8E/" rel="tag">JS地下城</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/" rel="tag">JavaScript</a></li></ul>

            
          </div>
          
        </div>
      
        <div class="article-entry" itemprop="articleBody">
          <blockquote>
<p>本篇為六角學院 - JS地下城攻略文　<a href="https://github.com/f820602h/Canvas" target="_blank" rel="noopener">Github</a>｜<a href="https://f820602h.github.io/Canvas/" target="_blank" rel="noopener">Demo</a></p>
</blockquote>
</br>

<h2 id="確認需求"><a href="#確認需求" class="headerlink" title="確認需求"></a>確認需求</h2><ul>
<li>讓使用者可以使用滑鼠在畫布上繪圖</li>
<li>畫筆要可以進行基本設定(粗細、顏色)</li>
<li>一些畫布的基本功能(清空、復原、重做)</li>
<li>能夠將畫作下載為圖檔</li>
</ul>
<p><strong>另外還可以設計一些額外功能作為加分項目</strong></p>
<hr>
<h2 id="解題攻略"><a href="#解題攻略" class="headerlink" title="解題攻略"></a>解題攻略</h2></br>

<h4 id="準備畫布"><a href="#準備畫布" class="headerlink" title="# 準備畫布"></a># 準備畫布</h4><p>先查查 MDN，發現原來要先建構 <code>&lt;canvas&gt;</code> 的渲染環境，用 <code>getContext(&#39;2d&#39;)</code> 來取得2D的繪圖環境，這樣後面才能使用相關的繪圖方法。</p>
<pre><code class="html">&lt;canvas id=&quot;draw&quot;&gt;&lt;/canvas&gt;</code></pre>
<pre><code class="javascript">let canvas = document.querySelector(&quot;#draw&quot;);
let ctx = canvas.getContext(&quot;2d&quot;);</code></pre>
<p>在來要決定畫布的大小，以供我們畫圖，官方建議用 <code>&lt;canvas&gt;</code> 的 <code>width</code> <code>height</code> 的屬性設定，避免用css修改，不然會有繪圖比例的問題。<br>這次的需求剛好是滿版的畫布，所以就這麼設定吧！</p>
<pre><code class="javascript">function setSize() {
  let canvasWidth = window.innerWidth();
  let canvasHeight = window.innerHeight();
  canvas.setAttribute(&quot;width&quot;, canvasWidth);
  canvas.setAttribute(&quot;height&quot;, canvasHeight);
}</code></pre>
<p>準備好畫布後，就來簡單畫幾筆吧。</p>
<pre><code class="javascript">// 開始繪圖
ctx.beginPath();
// 設定起始座標
ctx.mobeTo(x, y);
// 設定終點座標
ctx.lineTo(x, y);
// 繪製
ctx.stroke();</code></pre>
<p>藉由上面四個步驟就可以兩點連唯一線，畫出一條直線囉。</p>
<p><img src="https://cdn-images-1.medium.com/max/6240/1*Os7N1DpSdK-2o7IxTLERww.png" alt=""></p>
<p></br></br></p>
<h4 id="畫筆設定"><a href="#畫筆設定" class="headerlink" title="# 畫筆設定"></a># 畫筆設定</h4><p>成功畫出第一筆後卻發現只有一條細細醜醜的黑線，來試著改變畫筆的顏色粗細吧。</p>
<pre><code class="javascript">ctx.strokeStyle = &quot;#FFA500&quot;;
ctx.lineWidth = 10;
ctx.lineCap = &quot;round&quot;;</code></pre>
</br>

<p><img src="https://cdn-images-1.medium.com/max/6288/1*Mtx3i8B45xDlW3cqikDc2A.png" alt=""></p>
<p></br></br></p>
<h4 id="繪畫互動"><a href="#繪畫互動" class="headerlink" title="# 繪畫互動"></a># 繪畫互動</h4><p>畫筆、畫布都有了，但為了讓使用者可以利用滑鼠來繪圖，必須要把上面的畫直線方法來跟滑鼠事件連動。</p>
<pre><code class="javascript">let lastPointX, lastPointY;

let downHandler = function(e){
  // 滑鼠按下去時得到座標存在變數中作為等等畫圖的起點
  lastPointX = e.offsetX;
  lastPointY = e.offsetY;
  // 並且為Canvas綁定mousemove和mouseup的事件
  draw.addEventListener(&quot;mousemove&quot;, moveHandler);
  draw.addEventListener(&quot;mouseup&quot;, upHandler);
};

let moveHandler = function(e) {
  // 滑鼠在移動時我們把新的座標存下來作為終點
  let newPointX = e.offsetX;
  let newPointY = e.offsetY;

  // 畫圖四步驟
  ctx.beginPath();
  ctx.moveTo(lastPointX, lastPointY);
  ctx.lineTo(newPointX, newPointY);
  ctx.stroke();

  // 把終點改為新的起點
  lastPointX = newPointX;
  lastPointY = newPointY;
};

let upHandler = function(){
  // 滑鼠釋放後把剛剛綁定的事件移除
  draw.removeEventListener(&quot;mousemove&quot;, moveHandler);
  draw.removeEventListener(&quot;mouseup&quot;, upHandler);
};

draw.addEventListener(&quot;mousedown&quot;, downHandler)</code></pre>
<p>透過鼠標的事件綁定，就可以做到類似小畫家的繪圖功能，而實際上畫出來的線條，其實是無數條 <code>１pixel</code> 的直線所串連起來的。<br>簡單來說就是利用滑鼠移動的事件來不斷取得新座標，並且把座標丟進 moveTo() 和 lineTo() 之中，而滑鼠按下和放開只是啟動和關閉的作用。</p>
</br>

<p><img src="https://cdn-images-1.medium.com/max/5876/1*nh08sP6qPOrNvnRh-23sNg.png" alt=""></p>
<p></br></br></p>
<h4 id="進階功能"><a href="#進階功能" class="headerlink" title="# 進階功能"></a># 進階功能</h4><p>有了基本的繪圖功能，來思考該如何達到「復原」和「重做」吧。<br>看了看文件，發現 <code>Path2D Object</code> 和 <code>save()</code> <code>restore()</code> 好像蠻符合我們要的概念的。</p>
</br>

<p><strong>不過仔細研究會發現：</strong></p>
<ul>
<li>Path2D Object 是利用 <code>MyPath = new Path2D()</code> 來建立一個路徑物件，可以事先存取路徑再利用 <code>ctx.stroke(MyPath)</code> 畫出來，但這個物件只能存取路徑卻無法存取畫筆顏色和樣式。</li>
<li>而 <code>save()</code> <code>restore()</code> 可以存取畫布狀態並重新呼叫，但一次只能存取一個狀態到 stack 中，看來也不是我們需要的。</li>
</ul>
</br>

<p>後來找到 <code>toDataURL()</code>，它可以幫我們把畫布狀態編碼為 <code>base64</code> 的字串，這樣就可以存取了。<br>先來定義兩個變數 step 用來紀錄步數 history 用來紀錄每一步的筆畫。每畫一筆步數就 +1，並且把base64 存進 history 中。</p>
<pre><code class="javascript">let step = -1;
let history = [];

let push = function(){
  step++;
  if (step &lt;= history.length - 1) history.length = step
  history.push(canvas.toDataURL())
}

// 記得將push()加入upHandler中</code></pre>
<p>但為何中間要有一個判斷式呢？我們來思考一下，下面是我們畫圖時的步驟：</p>
<pre><code class="javascript">A -&gt; B -&gt; C -&gt; D   step = 3
// 我們總共畫了四筆，分別都存進 history[A,B,C,D]

A -&gt; B -&gt; C   [D]  step = 2
// 我們發現Ｄ畫錯了，所以復原到Ｃ，但Ｄ仍然是 history 裡的第[3]步

A -&gt; B -&gt; C -&gt; E  [D̶] step = 3
// 這時候我們重畫了一個Ｅ，它是新的第[3]步，而舊的Ｄ必須被我們覆蓋掉
// history[A,B,C,E]</code></pre>
<p>這樣應該就很好理解了，而現在每一筆都被記錄下來了，那該怎麼把紀錄給呼叫回來呢？</p>
<pre><code class="javascript">let undo = function(){
  // 創建一個新的圖像物件
  let lastDraw = new Image;

  // 確定有上一步我們才回到上一步
  if(step &gt; 0) step--;

  // 把上一部的base64設定給圖像物件
  lastDraw.src = history[step];

  // 把圖片載入後用畫布渲染出來
  lastDraw.onload = function(){
    ctx.clearRect(0, 0, canvasWidth, canvasHeight);
    ctx.drawImage(lastDraw, 0, 0);
  };
};</code></pre>
<p>這樣復原就完成了，而重做的概念剛好就是相反的囉。而其實裡面也藏了清除畫布的方法 <code>ctx.clearRect(0,0,canvasWidth,canvasHeight)</code>，這樣清除畫布的功能也一起做好了。</p>
<p></br></br></p>
<h4 id="保存作品"><a href="#保存作品" class="headerlink" title="# 保存作品"></a># 保存作品</h4><p>實現復原重做後，保存其實也是一樣道理。</p>
<pre><code class="javascript">let save = document.querySelector(&quot;#save&quot;);

save.addEventListener(&quot;click&quot;, function() {
  let link = canvas.toDataURL(&quot;image/png&quot;);
  this.setAttribute(&quot;href&quot;, link);
  this.setAttribute(&quot;download&quot;, &quot;canvas.png&quot;);
})</code></pre>
<p>在按下保存後，把畫布狀態利用 <code>toDataURL()</code> 編碼並設定在連結中，這樣可以下載了。</p>
<hr>
<h2 id="加分功能"><a href="#加分功能" class="headerlink" title="加分功能"></a>加分功能</h2></br>

<p>另外也可以增加替換顏色的功能，先用陣列來管理顏色再利用 <code>forEach()</code> 來生成元素。</p>
<pre><code class="javascript">let brushColor = [&quot;#ffffff&quot;,&quot;#000000&quot;,&quot;#9BFFCD&quot;,&quot;#00CC99&quot;,&quot;#01936F&quot;];</code></pre>
<p><img src="color1.png" alt=""></p>
<p>不過顏色有深有淺，若打勾圖示固定是黑色的，那在較深的顏色上就會不清楚，所以我們要來判斷目前所選的顏色是深是淺。</p>
<pre><code class="javascript">let isDark = function(color) {
  let rgbArray = [color.substr(1,2), color.substr(3,2), color.substr(5,2)];

  let brightness =
  parseInt(`0x${rgbArray[0]}`) * 0.213 +
  parseInt(`0x${rgbArray[1]}`) * 0.715 +
  parseInt(`0x${rgbArray[2]}`) * 0.072

  return brightness &lt; 255 / 2
}</code></pre>
<p>先把16進位色碼拆開並轉為10進位數字，然後透過公式就能知道這個顏色是深是淺，也就能給予對應顏色的打勾圖示了。</p>
<p><img src="color2.png" alt=""></p>

        </div>
      
    
  </div>

  <footer class="article-footer">
    <!-- 
      <a href="https://maxleebk.com/2019/11/01/js-underground-7/#disqus_thread" class="article-comment-link">Comments</a>
     -->
    <div>
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Canvas/" rel="tag">Canvas</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JS%E5%9C%B0%E4%B8%8B%E5%9F%8E/" rel="tag">JS地下城</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/" rel="tag">JavaScript</a></li></ul>

    </div>
    <a data-url="https://maxleebk.com/2019/11/01/js-underground-7/" data-id="cktt6u0ve001v8soy0tldbmv1" class="article-share-link">分享</a>
  </footer>
  
    
<nav id="article-nav">
  
    <div id="article-nav-older" class="article-nav-link-wrap">
      
    </div>
  
  
    <div id="article-nav-newer" class="article-nav-link-wrap">
      
      <strong class="article-nav-caption">下一篇文章</strong></br>
      <a href="/2019/12/01/js-underground-8/" class="article-nav-title">
        
          JS地下城 - 井字遊戲
        
      </a>
      
    </div>
  
</nav>

  
</article>


<section id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript" target="_blank" rel="noopener">comments powered by Disqus.</a></noscript>
  </div>
</section>
</section>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2021 Max Lee ｜ Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Article</a>
  
</nav>
    
<script>
  var disqus_shortname = 'f820602h';
  
  var disqus_url = 'https://maxleebk.com/2019/11/01/js-underground-7/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>

<!-- Highlight.js -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@latest/build/styles/vs2015.min.css">
<script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@latest/build/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>